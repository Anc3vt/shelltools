#!/bin/bash

orange='\e[38;5;208m'
blue='\e[38;5;39m'
reset='\e[0m'


# 1. Принимаем все аргументы
search_terms=("$@")

# 2. Проверяем, переданы ли аргументы
if [ ${#search_terms[@]} -eq 0 ]; then
  echo "Please provide search terms."
  exit 1
fi

# 3. Выполняем поиск по ~/.bash_history для каждого аргумента по отдельности
history_results=""
for term in "${search_terms[@]}"; do
  # Для каждого термина добавляем результаты в переменную history_results
  history_results+=$(cat ~/.bash_history | tail -n 1000 | grep -i "$term" | awk '!seen[$0]++')
done

history_results=$(echo "$history_results" | head -n ${FAN_LIMIT:-20})

# Если результаты пустые, выводим сообщение и завершаем
if [ -z "$history_results" ]; then
  echo "Matches for '${search_terms[*]}' not found"
  exit 1
fi

# 4. Печатаем результаты с номерами строк
counter=1
history_entries=()
while IFS= read -r line; do
  echo "$counter) $line"
  history_entries+=("$line")
  ((counter++))
done <<< "$history_results"

# 5. Предлагаем пользователю выбрать номер
echo -n "?: "
read -r selected_number

# Проверяем, что пользователь ввёл число, которое существует
if ! [[ "$selected_number" =~ ^[0-9]+$ ]] || [ "$selected_number" -le 0 ] || [ "$selected_number" -gt "${#history_entries[@]}" ]; then
  echo "Invalid selected number"
  exit 1
fi

# 6. Получаем команду, соответствующую выбранному номеру
selected_command="${history_entries[$((selected_number - 1))]}"

echo
echo -n -e "$orange$(pwd)$reset> "

# Устанавливаем выбранную команду для редактирования
read -e -i "$selected_command" user_input

# 7. Когда пользователь нажмёт enter, команда будет выполнена (можно отредактировать до этого)
eval "$user_input"
